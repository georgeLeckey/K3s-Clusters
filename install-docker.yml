---
- hosts: server_initial
  become: true
  tasks:
  - name: Ensure /etc/apt/keyrings Directory Exists
    file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'
      owner: root
      group: root
  - name: Download Docker GPG key
    get_url:
      url: https://download.docker.com/linux/ubuntu/gpg
      dest: /etc/apt/keyrings/docker.asc
      owner: root
      group: root
      mode: '0644'
  - name: Add Docker repository to sources.list
    become: true
    ansible.builtin.shell:
      cmd: echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  - name: Update Package Cache
    become: yes
    ansible.builtin.apt:
      update_cache: yes
  - name: Install Required Packages
    apt:
      name: "{{ packages }}"
      state: present
    vars:
      packages:
        - docker-ce
        - docker-ce-cli
        - containerd.io
        - docker-buildx-plugin
        - docker-compose-plugin
  - name: Create Docker Group
    become: yes
    ansible.builtin.group:
      name: docker
      state: present
  - name: Add User to Docker Group
    become: yes
    ansible.builtin.user:
      name: "{{ ansible_user }}"
      groups: docker
      append: yes  